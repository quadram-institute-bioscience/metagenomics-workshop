---
title: "MetaPhlAn4"
---
# MetaPhlAn4: Marker Gene-Based Taxonomic Profiling

---

### What is MetaPhlAn4?

**MetaPhlAn4** (Metagenomic Phylogenetic Analysis) is a computational tool for profiling the taxonomic composition of microbial communities from metagenomic shotgun sequencing data.

**Key Features:**
- Uses ~1.1 million unique **clade-specific marker genes**
- Prioritizes **specificity over sensitivity**
- Provides **relative abundance** estimates (%)
- Reports taxonomy from **kingdom to strain level**

### How Does MetaPhlAn4 Work?

1. **Marker Gene Database (ChocoPhlAn)**
   - Contains uniquely identifying marker genes for ~100,000 reference genomes
   - Each marker is specific to a particular clade (species, genus, family, etc.)
   - Markers are carefully selected to avoid cross-mapping

2. **Alignment Step**
   - Reads are mapped to the marker gene database using Bowtie2
   - Only reads that map to marker genes are used for profiling
   - Unmapped reads are considered "unclassified"

3. **Abundance Calculation**
   - Relative abundances calculated from marker gene coverage
   - Higher coverage = higher abundance
   - Results normalized to sum to 100%

### Advantages

‚úÖ **High specificity** - Low false positive rate  
‚úÖ **Fast** - Only maps to markers, not full genomes  
‚úÖ **Relative abundances** - Ready for downstream statistical analyses  

### Limitations

‚ö†Ô∏è **High unclassified fraction** - Especially in novel/understudied environments  
‚ö†Ô∏è **Database-dependent** - Can only detect organisms in the database  
‚ö†Ô∏è **Lower sensitivity** - May miss rare or novel taxa  
‚ö†Ô∏è **Compositional data** - Relative abundances, not absolute counts  

### When to Use MetaPhlAn4?

- When you need **high confidence** in detected organisms
- For **comparative studies** across samples
- When working with **well-characterized environments** (human gut, etc.)

---

## Hands-On: Running and Exploring MetaPhlAn4

### Prerequisites

Make sure you have:
- Access to the workshop notebook
- Data symlinked to your workspace
- MetaPhlAn4 conda environment available
- RStudio access on the notebook

---

## Part 1: Understanding the Database

### Database Organization

MetaPhlAn4 requires a pre-built database of marker genes. For this workshop, the database is located at:

```
/shared/team/2025_training/week5/databases/metaphlan/
```

**Key files in the database:**
- `*.bt2l` - Bowtie2 index files (for read mapping)
- `*.pkl` - Marker gene database (pickled Python object)
- `*_species.txt` - List of species in the database

**To explore:**
```bash
ls -lh /shared/team/2025_training/week5/databases/metaphlan/
```

---

## Part 2: Running MetaPhlAn4

### Step 1: Activate the Environment

```bash
conda activate metaphlan
```

### Step 2: Check Installation

```bash
metaphlan --version
```

### Step 3: View Help

```bash
metaphlan --help
```

**Key parameters to understand:**
- Input files (paired-end: comma-separated, no space!)
- `--input_type fastq` - Specifies input format
- `--db_dir` - Path to database directory
- `--offline` - Don't check for database updates
- `--nproc` - Number of processors to use
- `-o` or `--output_file` - Path to output file
- `--mapout` - Save Bowtie2 alignment (for re-analysis)
- `--skip_unclassified_estimation` - Turn off unclassified estimation (default: ON)

### Step 4: Construct the Command

For paired-end reads, MetaPhlAn4 requires input files separated by a comma with **NO SPACE**.

**Template:**
```bash
metaphlan [FORWARD],[REVERSE] \
    --input_type fastq \
    --db_dir [DATABASE_PATH] \
    --offline \
    --nproc [N] \
    -o [OUTPUT] \
    --mapout [MAPPING_OUTPUT]
```

**Example command for our dataset:**
```bash
metaphlan raw/subset_1.fastq.gz,raw/subset_2.fastq.gz \
    --input_type fastq \
    --db_dir /shared/team/2025_training/week5/databases/metaphlan \
    --offline \
    --nproc 16 \
    -o results/metaphlan/subset_profile.txt \
    --mapout results/metaphlan/subset.mapout.bz2
```

‚è±Ô∏è **Runtime:** 5-10 minutes for the subset sample

üí° **Tip:** The `--mapout` file can be reused to re-run MetaPhlAn4 with different parameters without re-mapping reads!

---

## Part 3: Understanding MetaPhlAn4 Output

### Output Format

MetaPhlAn4 produces a tab-delimited file with two columns:

```
clade_name	relative_abundance
k__Bacteria|p__Firmicutes|c__Bacilli|...|s__Leuconostoc_mesenteroides	15.42
k__Bacteria|p__Firmicutes|c__Bacilli|...|s__Lactiplantibacillus_plantarum	8.73
...
```

**Column 1: Taxonomic lineage**
- Uses `|` as separator
- Taxonomic prefixes:
  - `k__` = Kingdom
  - `p__` = Phylum
  - `c__` = Class
  - `o__` = Order
  - `f__` = Family
  - `g__` = Genus
  - `s__` = Species
  - `t__` = Strain (clade)

**Column 2: Relative abundance (%)**
- Values sum to 100% (for classified reads)
- All taxonomic levels are reported

**Optional: UNCLASSIFIED entry**
- If unclassified estimation is enabled (default), an additional line shows the percentage of unclassified reads
- Format: `UNCLASSIFIED	63.4` (63.4% of reads unclassified)

---

## Part 4: Exploring Outputs in RStudio

Open RStudio on your notebook and follow along!

### Load Required Libraries

```r
library(tidyverse)
```

### Read the MetaPhlAn4 Profile

```r
# Read a precomputed profile
profile <- read_tsv("tax_profiles/metaphlan4/ERR2231567.profile.txt", 
                    comment = "#",
                    show_col_types = FALSE)

# Look at the first few lines
profile %>% head(20)

# Check dimensions
profile %>% 
  summarise(n_entries = n())
```

### Compare Profiles With/Without Unclassified Estimation

```r
# Read profile WITH unclassified
profile_uncl <- read_tsv("tax_profiles/metaphlan4/ERR2231567.unclprofile.txt",
                         comment = "#",
                         show_col_types = FALSE)

# Read profile WITHOUT unclassified  
profile_no_uncl <- read_tsv("tax_profiles/metaphlan4/ERR2231567.profile.txt",
                            comment = "#",
                            show_col_types = FALSE)

# Check for UNCLASSIFIED entry
profile_uncl %>%
  filter(str_detect(clade_name, "UNCLASSIFIED"))

# What's the unclassified percentage?
unclass_pct <- profile_uncl %>%
  filter(clade_name == "UNCLASSIFIED") %>%
  pull(2)

cat("Unclassified percentage:", unclass_pct, "%\n")
```

**Question:** What does a high unclassified percentage tell us about the sample?

### Extract and Count Species

```r
# Extract only species-level entries (has "s__" but not "t__")
species <- profile %>%
  filter(str_detect(clade_name, "s__"),
         !str_detect(clade_name, "t__"))

# Count species
n_species <- species %>% nrow()
cat("Number of species detected:", n_species, "\n")
```

### View Top 10 Most Abundant Species

```r
# Sort by abundance and extract species names
species_clean <- species %>%
  arrange(desc(.[[2]])) %>%  # Sort by abundance column
  mutate(species_name = str_extract(clade_name, "[^|]+$")) %>%  # Extract after last |
  select(species_name, abundance = 2)

# Show top 10
cat("\nTop 10 most abundant species:\n")
species_clean %>% 
  head(10) %>%
  print()
```

### Visualize Top Species

```r
# Bar plot of top 10 species
species_clean %>%
  head(10) %>%
  mutate(species_name = str_trunc(species_name, 40)) %>%
  mutate(species_name = fct_reorder(species_name, abundance)) %>%
  ggplot(aes(x = species_name, y = abundance)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 10 Species in ERR2231567",
       x = "Species",
       y = "Relative Abundance (%)") +
  theme_minimal()
```

### Explore Family-Level Composition

```r
# Extract family-level abundances
families <- profile %>%
  filter(str_detect(clade_name, "f__"),
         !str_detect(clade_name, "g__")) %>%  # Family level only
  mutate(family_name = str_extract(clade_name, "f__[^|]+")) %>%
  select(family_name, abundance = 2) %>%
  arrange(desc(abundance))

# Show top 10 families
cat("\nTop 10 families:\n")
families %>% head(10)

# Visualize
families %>%
  head(10) %>%
  mutate(family_name = fct_reorder(family_name, abundance)) %>%
  ggplot(aes(x = family_name, y = abundance)) +
  geom_col(fill = "darkgreen") +
  coord_flip() +
  labs(title = "Top 10 Families in ERR2231567",
       x = "Family",
       y = "Relative Abundance (%)") +
  theme_minimal()
```

---

## Additional Resources

üìñ **MetaPhlAn4 Documentation:** https://github.com/biobakery/MetaPhlAn  
üí¨ **BioBakery Forum:** https://forum.biobakery.org/c/Microbial-community-profiling/MetaPhlAn/  
üìä **MetaPhlAn4 Paper:** Blanco-M√≠guez et al. (2023) Nature Biotechnology  

---
